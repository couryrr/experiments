<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tick-Tac-Toe</title>
    <style>
        .board {
            margin: 0 auto;
            border-spacing: 0;
        }

        .fixed {
            width: 500px;
            height: 500px;
        }

        .bottom {
            border-bottom: 1px solid black;
        }

        .top {
            border-top: 1px solid black;
        }

        .left {
            border-left: 1px solid black;
        }

        .right {
            border-right: 1px solid black;
        }

        .center, td {
            padding: 0;
            text-align: center;
        }
    </style>
</head>

<body>
    <div>
        <div class="center">Two Player: <input type="checkbox" checked name="" id="cpu" onclick="setAi()"></div>
        <div class="center" hidden id="marks">Player Mark: X <input type="radio" name="mark" value="X" onclick="setAiMark('o')">, O<input type="radio" name="mark" id="O" onclick="setAiMark('x')"></div>
        <div class="center"><button onclick="start()">Start</div>
        <br>
        <br>
        <table class="fixed board">
            <tr class="top row">
                <td id="0" class="right bottom"><canvas onclick="clicked(event)" width="200" height="200"></canvas>
                </td>
                <td id="1" class="bottom"><canvas onclick="clicked(event)" width="200" height="200"></canvas></td>
                <td id="2" class="left bottom"><canvas onclick="clicked(event)" width="200" height="200"></canvas>
                </td>
            </tr>
            <tr class="row">
                <td id="3" class="right"><canvas onclick="clicked(event)" width="200" height="200"></canvas></td>
                <td id="4"><canvas onclick="clicked(event)" width="200" height="200"></canvas></td>
                <td id="5" class="left"><canvas onclick="clicked(event)" width="200" height="200"></canvas></td>
            </tr>
            <tr class="bottom row">
                <td id="6" class="right top"><canvas onclick="clicked(event)" width="200" height="200"></canvas></td>
                <td id="7" class="top"><canvas onclick="clicked(event)" width="200" height="200"></canvas></td>
                <td id="8" class="left top"><canvas onclick="clicked(event)" width="200" height="200"></canvas></td>
            </tr>
        </table>
        <table id="scores" class="board">
            <thead>
                <tr>
                    <th>X</th>
                    <th>O</th>
                    <th>D</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                </tr>
            </tbody>
        </table>
    </div>
</body>

<script>
    const marks = {x:1, o:-1}
    let player = marks.x
    let state = Array(9)

    let started = false
    let ai = false
    let aiMark = marks.o;
    let playerMark = marks.x;
    let gameOver = false

    const magicSquare = [8, 1, 6, 3, 5, 7, 4, 9, 2]

    let xWins = 0
    let oWins = 0
    let draws = 0

    const start = () => {
        if(ai){
            if(document.getElementsByName("mark")[0].checked || document.getElementsByName("mark")[1].checked){
                started = true
                if(!document.getElementsByName("mark")[0].checked){
                    aiTurn(true)
                }
            } else {
                alert("Please choose a mark")
            }
        } else {
            started = true
        }
    }

    const setAi = () =>{
        ai = !document.getElementById("cpu").checked
        showMark(!ai)
    }

    const setAiMark = (mark) =>{
        aiMark = marks[mark]
        playerMark = aiMark === marks.x ? marks.o : marks.x
    }

    const showMark = (show) =>{
        document.getElementById("marks").hidden = show
    }

    const isGameOver = (board) => {
        if (isWinner(board)) {
            if (player === marks.x) {
                xWins += 1
                alert("X wins!")

            } else {
                oWins += 1
                alert("O wins!")
            }
            return true
        }

        if (isDraw(board)) {
            draws += 1
            alert("Game is a Draw")
            return true
        }
    }

    const clicked = (event) => {
        if(started){
            const id = event.target.parentElement.attributes['id'].value
            turn(id)
        }
    }

    const turn = (position) => {
        if (play(position)) {
            next()
        } else {
            alert("Invalid Move")
        }
    }

    const aiTurn = (random=false) => {
        let position = null;
        if(random){
            position = Math.floor((Math.random() * 9))
        } else {
            position = bestMove();
        }
        if (play(position)) {
            next()
        } else {
            aiTurn(random)
        }
    }

    const next = (position) => {
        gameOver = isGameOver([...state]);
        player = player === marks.x ? player = marks.o : player = marks.x;
        if (gameOver) {
            reset()
        } else if(ai && player === aiMark) {
            aiTurn()
        }
    }

    const play = (id) => {
        if(state[id] === undefined){
            state[parseInt(id)] = player * magicSquare[parseInt(id)]
            player === marks.x ? drawX(id) : drawCircle(id);
            return true
        } else {
            return false
        }
    }

    const bestMove = () => {
        const result = minimax([...state], true)
        console.log(`AI move is ${result.move}`);
        return result.move;
    }

    const minimax = (board, mmPlayer, count = 0) => {
        const openPositions = emptyIndex(board)
        const best = {}

        if(mmPlayer){
            best.move = null
            best.score = -Infinity
        } else {
            best.move = null
            best.score = Infinity
        }
        
        if(isWinner(board)){
            if(mmPlayer){
                return {move: null, score: -1}
            } else {
                return {move: null, score: 1}
            }
        } else if(isDraw(board)){
            return {move: null, score: 0}
        }

        for (let i = 0; i < openPositions.length; i++) {
            
            const thisBoard = playTest(openPositions[i], [...board], mmPlayer ? aiMark: playerMark)        

            var result = minimax([...thisBoard], !mmPlayer, count)
            
            if(mmPlayer && result.score > best.score ) {
                best.move = openPositions[i];
                best.score = result.score
            }
            if(!mmPlayer && result.score < best.score ) {
                best.move = openPositions[i];
                best.score = result.score
            }
            
        };
        
        return best;
    }

    const emptyIndex = (board)=> {
        let indexes = [];
        for (let i = 0; i < board.length; i++){
            if (board[i] === undefined) indexes.push(i);
        }
        return indexes;
    }

    const playTest = (id, board, player) => {
        board[parseInt(id)] = player * magicSquare[parseInt(id)]
        return board;
    }

    const reset = () => {
        player = marks.x
        state = new Array(9)
        gameOver = false
        const canvases = document.getElementsByTagName("canvas")

        Array.from(canvases).forEach((canvas) => {
            canvas.getContext("2d").clearRect(0, 0, canvas.width, canvas.height)
        })

        document.getElementById("scores").rows[1].cells.item(0).innerHTML = xWins.toString()
        document.getElementById("scores").rows[1].cells.item(1).innerHTML = oWins.toString()
        document.getElementById("scores").rows[1].cells.item(2).innerHTML = draws.toString()

        if(ai && aiMark == marks.x){
            aiTurn(true)
        }

    }

    const isDraw = (board) => {
        return emptyIndex(board).length == 0;
    }

    //keeping board to make AI easier
    const isWinner = (board) => {
        //Vertical rows
        if (Math.abs(board[0] + board[3] + board[6]) === 15) return true
        if (Math.abs(board[1] + board[4] + board[7]) === 15) return true
        if (Math.abs(board[2] + board[5] + board[8]) === 15) return true

        //Horizantal Columns
        if (Math.abs(board[0] + board[1] + board[2]) === 15) return true
        if (Math.abs(board[3] + board[4] + board[5]) === 15) return true
        if (Math.abs(board[6] + board[7] + board[8]) === 15) return true

        //Diagnols
        if (Math.abs(board[0] + board[4] + board[8]) === 15) return true
        if (Math.abs(board[2] + board[4] + board[6]) === 15) return true
        return false
    }

    const drawX = (id) => {
        const ctx = document.getElementById(id).firstChild.getContext("2d")

        ctx.beginPath();

        ctx.moveTo(100, 100);
        ctx.lineTo(60, 60);

        ctx.moveTo(100, 100);
        ctx.lineTo(140, 140);

        ctx.moveTo(100, 100);
        ctx.lineTo(140, 60);

        ctx.moveTo(100, 100);
        ctx.lineTo(60, 140);

        ctx.stroke();
    }

    const drawCircle = (id) => {
        const ctx = document.getElementById(id).firstChild.getContext("2d")
        ctx.beginPath()
        ctx.arc(100, 100, 50, 0, 2 * Math.PI);
        ctx.stroke();
    }
</script>

</html>